<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-icons/editor-icons.html">
<link rel="import" href="../iron-icons/iron-icons.html">
<script type="text/javascript" src="../rangy/rangy-core.js"></script>
<script type="text/javascript" src="../rangy/rangy-classapplier.js"></script>
<script type="text/javascript" src="../rangy/rangy-highlighter.js"></script>

<dom-module id="corespring-highlight-button">
  <style>
    :host {
      width: 24px;
      height: 24px;
      display: inline-block;
      vertical-align: middle;
    }

    :host button{
      border: none;
      background-color: white;
      padding: 0;
      margin: 0;
    }

  </style>
  <template>
    <button id="holder" on-click="onClick"></button>
    <!-- note: 
    using a icon here removes the selection - preventing highighting from working 
    <iron-icon on-click="onClick" icon="{{currentIcon}}"></iron-icon>

    For now we are manually setting the icon into a button.
    -->
  </template>
</dom-module>
<script>
  Polymer({
    is: 'corespring-highlight-button',
    properties: {
      highlightSelector: {
        type: String,
        value: 'corespring-highlight-behavior'
      }
    },
    ready: function(){
      this.meta = Polymer.Base.create('iron-meta', {type: 'iconset'});

      this.highlighter = document.querySelector(this.highlightSelector);
        
        if(!this.highlighter){
          throw new Error('can not find a highlighter'); 
        }

        this.highlighter.addEventListener('highlight-selected', function(){
          this.hasSelection = true;
          this.highlighted = true;
          this.updateIcon();
        }.bind(this));
            
        this.highlighter.addEventListener('range-selected', function(){
          this.hasSelection = true;
          this.highlighted = false;
          this.updateIcon();
        }.bind(this));
            
        this.highlighter.addEventListener('no-range-selected', function(){
          this.hasSelection = false;
          this.highlighted = false;
          this.updateIcon();
        }.bind(this));

        this.updateIcon();
    },
    onClick: function(){
      if(this.hasSelection){ 
        if(this.highlighted){
          this.highlighter.removeHighlight();
        } else {
          this.highlighter.highlight();
        }
      } 
    },
    updateIcon: function(){
      if(this.hasSelection && this.highlighted){
        this._updateIcon('icons:clear');
      } else {
        this._updateIcon('editor:mode-edit');
      }
    },
    _updateIcon: function(name){
      var arr = name.split(':');
      var iconName = arr.pop();
      var iconSetName = arr.pop();
      var iconset = this.meta.byKey(iconSetName);
      iconset.applyIcon(this.$.holder, iconName);
    }
  });
</script>

<dom-module id="corespring-highlight-behavior">
</dom-module>
<script>

  Polymer({
    is: 'corespring-highlight-behavior', 
    properties: {
      target: {
        type : String
      },
      contextMenu: {
        type: Boolean,
        value: true
      }
    },
    highlight: function() {
      var sel = rangy.getSelection();
      console.log('selection: ', sel);
      this.highlighter.highlightSelection('highlight');
    },
    removeHighlight: function() {
      this.highlighter.unhighlightSelection();
    },
    attached: function(){
      rangy.init();
      this.highlighter = rangy.createHighlighter();

      this.applier = rangy.createClassApplier('highlight', {
        ignoreWhiteSpace: true,
        tagNames: ['*']
      });

      this.highlighter.addClassApplier(this.applier);

      var node = document.querySelector(this.target);

      if(!node){
        throw new Error('can not find node: ' + this.target);
      } 

      node.addEventListener('mouseup', function(event){
        if(this.applier.isAppliedToSelection()){
          this.fire('highlight-selected');
        } else {
          var sel = rangy.getSelection();
          if(sel.rangeCount > 0 && sel.nativeSelection.type === 'Range'){
            this.fire('range-selected');
          } else {
            this.fire('no-range-selected');
          }
        }
      }.bind(this));
    }
  })
</script>